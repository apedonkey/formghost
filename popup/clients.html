<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Clients - FormGhost</title>
  <link rel="stylesheet" href="popup.css">
  <link rel="stylesheet" href="clients.css">
  <link rel="stylesheet" href="csv-styles.css">
  <!-- Papa Parse for CSV handling -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
</head>
<body>
  <div class="container clients-container">
    <header class="header">
      <button class="btn-back" id="backBtn" title="Back to main">&#8592;</button>
      <h1 class="title">CLIENTS</h1>
      <button class="btn-icon-header" id="settingsBtn" title="AI Settings">&#9881;</button>
    </header>

    <!-- Search and Add -->
    <section class="search-section">
      <input type="text" id="searchInput" class="search-input" placeholder="Search clients...">
      <div class="btn-group">
        <button class="btn btn-primary btn-add" id="addClientBtn">+ Add</button>
        <button class="btn btn-outline btn-sm" id="importCsvBtn">Import CSV</button>
        <button class="btn btn-outline btn-sm" id="exportCsvBtn">Export CSV</button>
      </div>
      <input type="file" id="csvFileInput" accept=".csv" style="display: none;">
    </section>

    <!-- Client List -->
    <section class="clients-list" id="clientsList">
      <div class="empty-state" id="emptyState">
        <p>No clients yet.</p>
        <p>Add a client to get started with AI form filling.</p>
      </div>
    </section>

    <!-- Client Edit Modal -->
    <div class="modal" id="editModal" style="display: none;">
      <div class="modal-content modal-large">
        <div class="modal-header">
          <h3 id="editModalTitle">Add Client</h3>
          <button class="btn-close" id="closeEditModal">&times;</button>
        </div>
        <div class="modal-body">
          <form id="clientForm">
            <!-- Basic Info -->
            <div class="form-section">
              <h4>Basic Information</h4>
              <div class="form-row">
                <div class="form-group">
                  <label>First Name *</label>
                  <input type="text" name="firstName" required>
                </div>
                <div class="form-group">
                  <label>Middle Name</label>
                  <input type="text" name="middleName">
                </div>
                <div class="form-group">
                  <label>Last Name *</label>
                  <input type="text" name="lastName" required>
                </div>
              </div>
              <div class="form-row">
                <div class="form-group">
                  <label>Date of Birth</label>
                  <input type="date" name="dob">
                </div>
              </div>
            </div>

            <!-- Contact -->
            <div class="form-section">
              <h4>Contact</h4>
              <div class="form-row">
                <div class="form-group">
                  <label>Email</label>
                  <input type="email" name="email">
                </div>
                <div class="form-group">
                  <label>Phone</label>
                  <input type="tel" name="phone" placeholder="(555) 555-5555">
                </div>
                <div class="form-group">
                  <label>Alt Phone</label>
                  <input type="tel" name="phoneAlt">
                </div>
              </div>
            </div>

            <!-- Address -->
            <div class="form-section">
              <h4>Address</h4>
              <div class="form-row">
                <div class="form-group form-group-wide">
                  <label>Street Address</label>
                  <input type="text" name="address">
                </div>
              </div>
              <div class="form-row">
                <div class="form-group form-group-wide">
                  <label>Address Line 2</label>
                  <input type="text" name="addressLine2" placeholder="Apt, Suite, etc.">
                </div>
              </div>
              <div class="form-row">
                <div class="form-group">
                  <label>City</label>
                  <input type="text" name="city">
                </div>
                <div class="form-group form-group-small">
                  <label>State</label>
                  <input type="text" name="state" maxlength="2" placeholder="CA">
                </div>
                <div class="form-group">
                  <label>ZIP</label>
                  <input type="text" name="zip" maxlength="10">
                </div>
              </div>
            </div>

            <!-- Identification (Collapsible) -->
            <details class="form-section collapsible">
              <summary>Identification (Optional)</summary>
              <div class="form-row">
                <div class="form-group form-group-small">
                  <label>SSN Last 4</label>
                  <input type="text" name="ssnLast4" maxlength="4" placeholder="****">
                </div>
                <div class="form-group">
                  <label>Driver's License</label>
                  <input type="text" name="driversLicense">
                </div>
                <div class="form-group form-group-small">
                  <label>DL State</label>
                  <input type="text" name="dlState" maxlength="2">
                </div>
              </div>
            </details>

            <!-- Employment (Collapsible) -->
            <details class="form-section collapsible">
              <summary>Employment (Optional)</summary>
              <div class="form-row">
                <div class="form-group">
                  <label>Employer</label>
                  <input type="text" name="employer">
                </div>
                <div class="form-group">
                  <label>Occupation</label>
                  <input type="text" name="occupation">
                </div>
                <div class="form-group">
                  <label>Work Phone</label>
                  <input type="tel" name="workPhone">
                </div>
              </div>
            </details>

            <!-- Custom Fields (Collapsible) -->
            <details class="form-section collapsible">
              <summary>Custom Fields</summary>
              <div id="customFieldsContainer"></div>
              <button type="button" class="btn btn-sm btn-outline" id="addCustomFieldBtn">
                + Add Custom Field
              </button>
            </details>
          </form>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" id="cancelEditBtn">Cancel</button>
          <button class="btn btn-primary" id="saveClientBtn">Save Client</button>
        </div>
      </div>
    </div>

    <!-- Settings Modal -->
    <div class="modal" id="settingsModal" style="display: none;">
      <div class="modal-content">
        <div class="modal-header">
          <h3>AI Fill Settings</h3>
          <button class="btn-close" id="closeSettingsModal">&times;</button>
        </div>
        <div class="modal-body">
          <div class="form-section">
            <h4>API Configuration</h4>
            <div class="form-group">
              <label>Anthropic API Key</label>
              <div class="input-with-button">
                <input type="password" id="apiKeyInput" placeholder="sk-ant-...">
                <button type="button" class="btn btn-sm" id="toggleApiKey">Show</button>
              </div>
              <small class="form-hint">Get your API key from <a href="https://console.anthropic.com/settings/keys" target="_blank">console.anthropic.com</a></small>
            </div>
            <div class="form-group">
              <button class="btn btn-outline btn-sm" id="validateKeyBtn">Validate Key</button>
              <span id="keyStatus"></span>
            </div>
          </div>

          <div class="form-section">
            <h4>Privacy</h4>
            <label class="checkbox-label">
              <input type="checkbox" id="excludeSensitive" checked>
              <span>Exclude sensitive fields (SSN, DL) from AI processing</span>
            </label>
          </div>

          <div class="form-section">
            <h4>Formatting</h4>
            <div class="form-row">
              <div class="form-group">
                <label>Date Format</label>
                <select id="dateFormat">
                  <option value="MM/DD/YYYY">MM/DD/YYYY</option>
                  <option value="DD/MM/YYYY">DD/MM/YYYY</option>
                  <option value="YYYY-MM-DD">YYYY-MM-DD</option>
                </select>
              </div>
              <div class="form-group">
                <label>Phone Format</label>
                <select id="phoneFormat">
                  <option value="(###) ###-####">(555) 555-5555</option>
                  <option value="###-###-####">555-555-5555</option>
                  <option value="##########">5555555555</option>
                </select>
              </div>
            </div>
          </div>

          <div class="form-section">
            <h4>Caching</h4>
            <label class="checkbox-label">
              <input type="checkbox" id="cacheEnabled" checked>
              <span>Cache form mappings to reduce API calls</span>
            </label>
            <div class="cache-stats" id="cacheStats">
              <span>Cached: <strong>0</strong> forms</span>
              <button class="btn btn-sm btn-outline" id="clearCacheBtn">Clear Cache</button>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" id="cancelSettingsBtn">Cancel</button>
          <button class="btn btn-primary" id="saveSettingsBtn">Save Settings</button>
        </div>
      </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div class="modal" id="deleteModal" style="display: none;">
      <div class="modal-content modal-small">
        <div class="modal-header">
          <h3>Delete Client</h3>
          <button class="btn-close" id="closeDeleteModal">&times;</button>
        </div>
        <div class="modal-body">
          <p>Are you sure you want to delete <strong id="deleteClientName"></strong>?</p>
          <p class="text-muted">This action cannot be undone.</p>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" id="cancelDeleteBtn">Cancel</button>
          <button class="btn btn-danger" id="confirmDeleteBtn">Delete</button>
        </div>
      </div>
    </div>

    <!-- Export CSV Modal -->
    <div class="modal" id="exportCsvModal" style="display: none;">
      <div class="modal-content modal-small">
        <div class="modal-header">
          <h3>Export Clients to CSV</h3>
          <button class="btn-close" id="closeExportCsvModal">&times;</button>
        </div>
        <div class="modal-body">
          <p>Export <strong id="exportClientCount">0</strong> clients to CSV file.</p>
          <div class="form-section">
            <label class="checkbox-label">
              <input type="checkbox" id="exportIncludeSensitive">
              <span>Include sensitive fields (SSN, Driver's License)</span>
            </label>
            <small class="form-hint">⚠️ Use caution when sharing files with sensitive data</small>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" id="cancelExportCsvBtn">Cancel</button>
          <button class="btn btn-primary" id="confirmExportCsvBtn">Export</button>
        </div>
      </div>
    </div>

    <!-- Import CSV Preview Modal -->
    <div class="modal" id="importPreviewModal" style="display: none;">
      <div class="modal-content modal-large">
        <div class="modal-header">
          <h3>Import Clients from CSV</h3>
          <button class="btn-close" id="closeImportPreviewModal">&times;</button>
        </div>
        <div class="modal-body">
          <div class="import-summary">
            <p>Ready to import <strong id="importRowCount">0</strong> rows</p>
          </div>

          <div class="form-section">
            <h4>Column Mappings</h4>
            <div id="columnMappingsContainer" class="column-mappings"></div>
          </div>

          <div class="form-section">
            <h4>Preview (first 5 rows)</h4>
            <div id="importPreviewTable" class="preview-table"></div>
          </div>

          <div class="form-section">
            <h4>Duplicate Handling</h4>
            <p class="form-hint">How should we handle clients with matching name + (DOB or email)?</p>
            <select id="duplicateStrategy" class="form-select">
              <option value="skip">Skip duplicates (don't import)</option>
              <option value="update">Update existing clients</option>
              <option value="import">Import anyway (create duplicates)</option>
            </select>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" id="cancelImportPreviewBtn">Cancel</button>
          <button class="btn btn-primary" id="confirmImportBtn">Import</button>
        </div>
      </div>
    </div>

    <!-- Import Results Modal -->
    <div class="modal" id="importResultsModal" style="display: none;">
      <div class="modal-content modal-medium">
        <div class="modal-header">
          <h3>Import Complete</h3>
          <button class="btn-close" id="closeImportResultsModal">&times;</button>
        </div>
        <div class="modal-body">
          <div class="import-results">
            <div class="result-item result-success">
              <span class="result-icon">✓</span>
              <span>Successfully imported: <strong id="importedCount">0</strong> clients</span>
            </div>
            <div class="result-item result-info" id="updatedResult" style="display: none;">
              <span class="result-icon">↻</span>
              <span>Updated existing: <strong id="updatedCount">0</strong> clients</span>
            </div>
            <div class="result-item result-warning" id="skippedResult" style="display: none;">
              <span class="result-icon">⊘</span>
              <span>Skipped duplicates: <strong id="skippedCount">0</strong> clients</span>
            </div>
            <div class="result-item result-error" id="errorsResult" style="display: none;">
              <span class="result-icon">✗</span>
              <span>Rows with errors: <strong id="errorsCount">0</strong></span>
            </div>
          </div>

          <div id="errorDetails" class="error-details" style="display: none;">
            <h4>Error Details</h4>
            <div id="errorList"></div>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-primary" id="closeImportResultsBtn">Close</button>
        </div>
      </div>
    </div>
  </div>

  <script src="../lib/csvHandler.js"></script>
  <script src="clients.js"></script>
</body>
</html>
